<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Orders ‚Ä¢ Gauri Creations</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">

<style>
  body{ margin:0; padding:20px; font-family:'Poppins',sans-serif; background:linear-gradient(135deg,#e3f2ff,#ffe5f3); min-height:100vh; display:flex; justify-content:center; }
  
  /* FIXED WIDTH CONTAINER */
  .container { width: 100%; max-width: 800px; padding-bottom: 50px; }

  h2{ text-align:center; color:#333; margin-bottom:20px; }

  /* ANIMATED CARDS */
  .order-card{
    background:rgba(255,255,255,0.9); border-radius:16px; padding:16px; margin-bottom:15px;
    box-shadow:0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;
    border:1px solid rgba(255,255,255,0.6);
  }
  .order-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }

  .order-header{ display:flex; justify-content:space-between; font-weight:700; color:#2563eb; margin-bottom:8px; }
  .order-detail{ font-size:14px; color:#555; margin-bottom:4px; }
  .status-badge{ display:inline-block; padding:4px 10px; border-radius:12px; font-size:12px; background:#e0f2fe; color:#0284c7; font-weight:600; margin-top:8px; }

  /* REVIEW BUTTON */
  .btn-review {
    display:block; width:100%; text-align:center; margin-top:12px;
    padding:10px; background:linear-gradient(135deg,#2563eb,#ec4899);
    color:white; text-decoration:none; border-radius:10px; font-weight:600; cursor:pointer; border:none;
    transition: transform 0.2s;
  }
  .btn-review:hover { transform: scale(1.02); }
  .btn-review:active { transform: scale(0.97); }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px); z-index:1000; }
  .modal { background:white; padding:25px; border-radius:20px; width:90%; max-width:350px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,0.2); animation: popUp 0.3s; }
  @keyframes popUp { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
  
  textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; margin:10px 0; font-family:inherit; box-sizing: border-box; }
  .star-rating { font-size:30px; cursor:pointer; color:#ddd; }
  .star-rating span:hover, .star-rating span.active { color:#ffd700; }

  /* SUCCESS MESSAGE MODAL */
  .success-icon { font-size: 50px; margin-bottom: 10px; }
  
  .back-link { display:block; text-align:center; margin-top:20px; color:#666; text-decoration:none; }
</style>
</head>
<body>

<div class="container">
  <h2>üì¶ My Orders</h2>
  <div id="loading" style="text-align:center">Loading your orders...</div>
  <div id="ordersList"></div>
  <a href="store.html" class="back-link">‚Üê Back to Store</a>
</div>

<div class="modal-overlay" id="reviewModal">
  <div class="modal">
    <h3>Rate Product</h3>
    <div class="star-rating" id="stars">
      <span onclick="setRate(1)">‚òÖ</span><span onclick="setRate(2)">‚òÖ</span><span onclick="setRate(3)">‚òÖ</span><span onclick="setRate(4)">‚òÖ</span><span onclick="setRate(5)">‚òÖ</span>
    </div>
    <textarea id="reviewText" rows="3" placeholder="Write your review..."></textarea>
    <button class="btn-review" onclick="submitReview()">Submit Review</button>
    <button style="background:transparent; border:none; color:#999; margin-top:10px; cursor:pointer" onclick="closeModal()">Cancel</button>
  </div>
</div>

<div class="modal-overlay" id="successModal">
  <div class="modal">
    <div class="success-icon">üéâ</div>
    <h3>Thank You!</h3>
    <p>Your review has been submitted successfully.</p>
    <button class="btn-review" onclick="document.getElementById('successModal').style.display='none'">Close</button>
  </div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbyGE0vN4yxngAyqooJAnULrBQbbNc6kyluYSg7JgydWeJ5481HmsFxVgC8kCWBvE3Wq/exec";
const user = JSON.parse(localStorage.getItem("gc_customer")||"null");

if(!user) window.location.href="login.html";

// LOAD ORDERS
fetch(SCRIPT_URL+"?action=listOrders")
.then(r=>r.json())
.then(d=>{
  document.getElementById("loading").style.display="none";
  const list = document.getElementById("ordersList");
  
  const myOrders = d.orders.filter(o => 
    String(o["Phone"]) === String(user.phone) || 
    String(o["Customer Name"]) === String(user.name)
  );

  if(myOrders.length === 0){
    list.innerHTML = "<p style='text-align:center'>No orders found.</p>";
    return;
  }

  myOrders.reverse().forEach(o => {
    // Show Review button
    const canReview = true; 
    
    list.innerHTML += `
      <div class="order-card">
        <div class="order-header">
          <span>#${o["Order ID"]}</span>
          <span>‚Çπ${o["Total"]}</span>
        </div>
        <div class="order-detail"><strong>Product:</strong> ${o["Product Name"]}</div>
        <div class="order-detail"><strong>Date:</strong> ${o["Timestamp"].split('T')[0]}</div>
        <div class="status-badge">${o["Status"]}</div>
        
        ${canReview ? `<button class="btn-review" onclick="openReview('${o["Product SKU"]}', '${o["Product Name"]}')">‚òÖ Rate & Review</button>` : ''}
      </div>
    `;
  });
});

/* REVIEW LOGIC */
let currentSku = null;
let currentRating = 0;

function openReview(sku, name){
  currentSku = sku;
  currentRating = 0;
  updateStars();
  document.getElementById("reviewText").value = "";
  document.getElementById("reviewModal").style.display = "flex";
}

function setRate(n){
  currentRating = n;
  updateStars();
}

function updateStars(){
  const stars = document.querySelectorAll("#stars span");
  stars.forEach((s, i) => {
    s.className = i < currentRating ? "active" : "";
  });
}

function closeModal(){
  document.getElementById("reviewModal").style.display = "none";
}

async function submitReview(){
  const text = document.getElementById("reviewText").value;
  if(currentRating === 0){ alert("Please select star rating"); return; }

  const btn = document.querySelector(".modal .btn-review");
  const originalText = btn.textContent;
  btn.textContent = "Submitting...";
  
  await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "submitReview",
      sku: currentSku,
      rating: currentRating,
      comment: text,
      customerName: user.name
    })
  });

  // CLOSE REVIEW MODAL & OPEN SUCCESS MODAL
  closeModal();
  document.getElementById("successModal").style.display = "flex";
  
  btn.textContent = originalText;
}
</script>
</body>
</html>
