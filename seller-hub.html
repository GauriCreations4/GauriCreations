<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seller Hub ‚Ä¢ Gauri Creations</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  /* --- DASHBOARD STYLES (Screen Only) --- */
  body { margin:0; font-family:Poppins,system-ui; background:linear-gradient(135deg,#e3f2ff,#ffe5f3); padding:20px; }
  .container { max-width:1200px; margin:auto; background:#ffffffee; padding:22px; border-radius:22px; box-shadow:0 20px 40px rgba(0,0,0,.2); }
  h2 { margin-bottom:15px; }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  th,td { padding:10px; border-bottom:1px solid #ddd; text-align:left; vertical-align:middle; }
  th { background:#f1f5f9; }
  select,input { padding:6px; border-radius:8px; border:1px solid #ccc; font-size:13px; }
  .btn { padding:6px 14px; border:none; border-radius:999px; cursor:pointer; font-weight:600; font-size:12px; display:inline-flex; align-items:center; gap:4px; }
  .btn-primary { background:linear-gradient(135deg,#2563eb,#ec4899); color:#fff; }
  .btn-support { background:#22c55e; color:#fff; }

  /* --- PRINT TEMPLATE STYLES (Hidden on Screen) --- */
  #printArea { display:none; }

  @media print {
    body * { visibility:hidden; }
    #printArea, #printArea * { visibility:visible; }
    #printArea {
      display:block;
      position:absolute;
      left:0; top:0;
      width:100%;
      background:white;
      color:black;
      font-family: 'Arial', sans-serif;
    }
    
    .label-page {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      border: 2px solid #000;
      page-break-after: always;
    }

    /* SECTION 1: COURIER HEADER */
    .courier-header {
      display: flex;
      border-bottom: 2px solid #000;
      height: 220px;
    }
    .qr-box {
      width: 160px;
      padding: 10px;
      border-right: 2px solid #000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .address-box {
      flex: 1;
      padding: 10px;
      font-size: 12px;
      line-height: 1.4;
    }
    .routing-codes {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
    }
    .large-code {
      font-size: 24px;
      font-weight: 900;
      margin-top: 5px;
    }

    /* SECTION 2: PRODUCT SUMMARY */
    .product-summary {
      padding: 10px;
      border-bottom: 2px solid #000;
    }
    .mini-table {
      width: 100%;
      font-size: 11px;
      border: 1px solid #000;
    }
    .mini-table th { background: #eee; border: 1px solid #000; padding: 4px; }
    .mini-table td { border: 1px solid #000; padding: 4px; }

    /* SECTION 3: INVOICE */
    .invoice-section {
      padding: 15px;
    }
    .invoice-header {
      text-align: center;
      font-weight: bold;
      text-decoration: underline;
      margin-bottom: 10px;
    }
    .invoice-details {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 15px;
    }
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 20px;
    }
    .invoice-table th, .invoice-table td {
      border: 1px solid #000;
      padding: 6px;
      text-align: left;
    }
    .footer-note {
      font-size: 10px;
      font-style: italic;
    }
  }
</style>
</head>

<body>

<div class="container">
  <h2>üöö Seller Hub ‚Äì Shipping & Fulfillment</h2>
  <table id="ordersTable">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Status</th>
        <th>AWB</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="printArea"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGE0vN4yxngAyqooJAnULrBQbbNc6kyluYSg7JgydWeJ5481HmsFxVgC8kCWBvE3Wq/exec";

// Global store for orders
let globalOrders = [];

const STATUS_FLOW = ["Packing", "Shipped", "Out for Delivery", "Delivered"];

async function loadOrders(){
  try {
    const res = await fetch(SCRIPT_URL + "?action=listOrders");
    const data = await res.json();
    if(!data.success) return alert("Failed to load orders");

    globalOrders = data.orders;
    const tbody = document.querySelector("#ordersTable tbody");
    tbody.innerHTML = "";

    globalOrders
      .filter(o => String(o["Payment Status"]).toLowerCase() === "paid")
      .reverse()
      .forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${o["Order ID"]}</b><br><small>${o["Date"] || ""}</small></td>
          <td>${o["Customer Name"]}<br><small>${o["Phone"]}</small></td>
          <td>
            <select onchange="updateOrder('${o["Order ID"]}','status',this.value)">
              ${STATUS_FLOW.map(s => `<option ${o["Status"]===s?"selected":""}>${s}</option>`).join("")}
            </select>
          </td>
          <td>
             <input style="width:100px" placeholder="AWB" value="${o["AWB"]||""}" 
                    onchange="updateOrder('${o["Order ID"]}','awb',this.value)">
          </td>
          <td>
            <button class="btn btn-primary" onclick="printLabel('${o["Order ID"]}')">
              üñ®Ô∏è Label
            </button>
            <div style="height:5px"></div>
            <button class="btn btn-support" onclick="support('${o["Phone"]}')">
              üìû Chat
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
  } catch(e) {
    console.error(e);
    alert("Error loading orders.");
  }
}

/* üî• FIXED: GENERATE PROFESSIONAL LABEL */
function printLabel(orderId) {
  const order = globalOrders.find(o => o["Order ID"] === orderId);
  if (!order) return alert("Order data not found!");

  // 1. SMART DATA FETCHING (Fixes 'undefined')
  const price = parseFloat(order["Price"] || order["price"] || 0);
  const qty = parseInt(order["Qty"] || order["qty"] || 1);
  const total = order["Total Amount"] || order["Total"] || (price * qty);
  const pincode = order["Pincode"] || order["Pin"] || order["Zip"] || "";
  const address = order["Address"] || "";
  
  // Calculate Routing Code (Visual Dummy)
  const routingCode = `MH/${pincode.substring(0,3)}/${Math.floor(Math.random()*90)+10}`;

  const printDiv = document.getElementById("printArea");
  
  printDiv.innerHTML = `
    <div class="label-page">
      <div class="courier-header">
        <div class="qr-box" id="qrcode-${orderId}"></div>
        <div class="address-box">
          <div style="font-weight:bold; font-size:14px; margin-bottom:5px">DELIVER TO:</div>
          <div style="font-size:16px; font-weight:bold">${order["Customer Name"]}</div>
          <div>${address}</div>
          <div>${pincode ? pincode + "," : ""} Maharashtra</div>
          <div style="margin-top:8px"><b>Mobile:</b> ${order["Phone"]}</div>
          
          <div class="routing-codes">
             <div>COD: PREPAID</div>
             <div class="large-code">${routingCode}</div>
             <div>Standard Delivery</div>
          </div>
        </div>
      </div>

      <div class="product-summary">
        <b>Package Contents:</b>
        <table class="mini-table" style="margin-top:5px">
           <tr>
             <th>SKU / Product</th>
             <th>Qty</th>
             <th>Type</th>
           </tr>
           <tr>
             <td>${order["Product Name"] || "Handcrafted Item"}</td>
             <td>${qty}</td>
             <td>Fragile / Decor</td>
           </tr>
        </table>
        <div style="text-align:center; margin-top:10px">
           <svg id="barcode-${orderId}"></svg>
        </div>
      </div>

      <div class="invoice-section">
         <div class="invoice-header">TAX INVOICE / BILL OF SUPPLY</div>
         
         <div class="invoice-details">
            <div>
               <b>Sold By:</b><br>
               Gauri Creations Pvt Ltd<br>
               Vasai Virar, Maharashtra 401208<br>
               GSTIN: 27ABCDE1234F1Z5
            </div>
            <div style="text-align:right">
               <b>Order ID:</b> ${orderId}<br>
               <b>Invoice Date:</b> ${new Date().toLocaleDateString()}<br>
               <b>Payment:</b> Online / Paid
            </div>
         </div>

         <table class="invoice-table">
            <tr>
               <th>Description</th>
               <th>Qty</th>
               <th>Rate</th>
               <th>Tax</th>
               <th>Total</th>
            </tr>
            <tr>
               <td>${order["Product Name"]}</td>
               <td>${qty}</td>
               <td>Rs.${price}</td>
               <td>0%</td>
               <td>Rs.${total}</td>
            </tr>
            <tr>
               <td colspan="4" style="text-align:right"><b>Grand Total:</b></td>
               <td><b>Rs.${total}</b></td>
            </tr>
         </table>
         
         <div class="footer-note">
           * This is a computer generated invoice and does not require a physical signature.<br>
           * Returns valid only for damaged products with unboxing video.
         </div>
      </div>
    </div>
  `;

  // Generate QR Code
  new QRCode(document.getElementById(`qrcode-${orderId}`), {
    text: `${orderId} | ${order["Customer Name"]} | ${total}`,
    width: 128,
    height: 128
  });

  // Generate Barcode
  JsBarcode(`#barcode-${orderId}`, orderId, {
    format: "CODE128",
    height: 40,
    displayValue: true
  });

  // Trigger Print
  setTimeout(() => window.print(), 500);
}

async function updateOrder(orderId, field, value){
  const payload = { orderId };
  payload[field] = value;
  await fetch(SCRIPT_URL + "?action=updateOrderStatus",{
    method:"POST",
    body:JSON.stringify(payload)
  });
}

function support(phone){
  window.open(`https://wa.me/91${phone}`);
}

loadOrders();
</script>

</body>
</html>
